import React from"react";import createReactContext from"create-react-context";function _classCallCheck(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}var Vault=function(){function t(){_classCallCheck(this,t),this.__state={},this.__subscriptions={},this.__counter=0,this.stores={},this.debugMode&&(window.VAULT=this)}return t.prototype.getState=function(){return this.__state},t.prototype.updateState=function(t,e){this.__state[t]=e,this.notify()},t.prototype.subscribe=function(t){var e=this,o=++this.__counter;return this.__subscriptions[o]=t,function(){delete e.__subscriptions[o]}},t.prototype.notify=function(){var t=this;Object.keys(this.__subscriptions).forEach(function(e){var o=t.__subscriptions[e];o&&o(t.state)})},t}(),createVault=function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},o=Object.keys(t);if(!o.length)throw new Error("Provide at least one store while creating the vault. If you are having trouble, make sure you pass <Provider> either a valid vault or hash of Stores.");var n=new Vault(e);return o.forEach(function(o){var r=new(0,t[o])(o,n,e);n.stores[o]=r,n.updateState(o,r.state)}),n};function _classCallCheck$1(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}var Store=function(){function t(e,o){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};_classCallCheck$1(this,t),this.id=e,this.vault=o,this.logStateChanges=n.logStateChanges||!0}return t.prototype.setState=function(t,e){var o=(arguments.length>2&&void 0!==arguments[2]?arguments[2]:{}).hideStateChanges,n=void 0!==o&&o,r=void 0;r="function"==typeof t?t(this.state):t;var s=Object.assign({},this.state,r);!n&&this.debugMode&&this.logStateChanges&&this.logStateChange(this.state,s),this.state=s,this.vault.updateState(this.id,this.state),"function"==typeof e&&e(this.state)},t}();function _classCallCheck$2(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}function _possibleConstructorReturn(t,e){if(!t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!e||"object"!=typeof e&&"function"!=typeof e?t:e}function _inherits(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function, not "+typeof e);t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,enumerable:!1,writable:!0,configurable:!0}}),e&&(Object.setPrototypeOf?Object.setPrototypeOf(t,e):t.__proto__=e)}var Context=createReactContext({}),Consumer=Context.Consumer,Provider=function(t){function e(o){_classCallCheck$2(this,e);var n=_possibleConstructorReturn(this,t.call(this,o));return n.vault=o.vault?o.vault:createVault(o.stores),n}return _inherits(e,t),e.prototype.render=function(){return React.createElement(Context.Provider,{value:this.vault},this.props.children)},e}(React.Component),_extends=Object.assign||function(t){for(var e=1;e<arguments.length;e++){var o=arguments[e];for(var n in o)Object.prototype.hasOwnProperty.call(o,n)&&(t[n]=o[n])}return t},_typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t};function _objectWithoutProperties(t,e){var o={};for(var n in t)e.indexOf(n)>=0||Object.prototype.hasOwnProperty.call(t,n)&&(o[n]=t[n]);return o}function _classCallCheck$3(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}function _possibleConstructorReturn$1(t,e){if(!t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!e||"object"!=typeof e&&"function"!=typeof e?t:e}function _inherits$1(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function, not "+typeof e);t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,enumerable:!1,writable:!0,configurable:!0}}),e&&(Object.setPrototypeOf?Object.setPrototypeOf(t,e):t.__proto__=e)}var hasObjectChanged=function(t,e){var o=Object.keys(e),n=Array.isArray(o),r=0;for(o=n?o:o[Symbol.iterator]();;){var s;if(n){if(r>=o.length)break;s=o[r++]}else{if((r=o.next()).done)break;s=r.value}var i=s;if(t[i]!==e[i])return!0}return!1},Connect=function(t){function e(){var o,n;_classCallCheck$3(this,e);for(var r=arguments.length,s=Array(r),i=0;i<r;i++)s[i]=arguments[i];return o=n=_possibleConstructorReturn(this,t.call.apply(t,[this].concat(s))),n.unsubscribe=null,n.lastObservedState=null,_possibleConstructorReturn(n,o)}return _inherits$1(e,t),e.prototype.componentDidMount=function(){var t=this,e=this.props,o=e.lifecycle,n=e.vault;this.unsubscribe=n.subscribe(function(){t.setState(n.getState())}),o.didMount&&o.didMount.apply(o,this.getArgs())},e.prototype.componentDidCatch=function(t){console.log(t)},e.prototype.shouldComponentUpdate=function(t){var e=this.props.lifecycle;return e.shouldUpdate?e.shouldUpdate.apply(e,this.getArgs()):hasObjectChanged(this.lastObservedState,this.getObservedState())},e.prototype.componentDidUpdate=function(){var t=this.props.lifecycle;t.didUpdate&&t.didUpdate.apply(t,this.getArgs())},e.prototype.componentWillUnmount=function(){this.unsubscribe();var t=this.props.lifecycle;t.willUnmount&&t.willUnmount.apply(t,this.getArgs())},e.prototype.getArgs=function(){var t=this.props.vault;return[t.stores,t.state]},e.prototype.getObservedState=function(){var t=this.props.select.apply(void 0,this.getArgs());if("object"!==(void 0===t?"undefined":_typeof(t)))throw new Error('The "select" prop must return an object.');return this.lastObservedState=t,t},e.prototype.render=function(){var t=this.props,e=t.children,o=(t.vault,_objectWithoutProperties(t,["children","vault"]));return e(this.getObservedState(),o)},e}(React.Component);Connect.defaultProps={select:function(){},lifecycle:{}};var connect=function(t){return React.createElement(Consumer,null,function(e){return React.createElement(Connect,_extends({},t,{vault:e}))})};export{createVault,Store,Provider,connect as Connect};
